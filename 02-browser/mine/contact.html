<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h2>연락처 관리 프로그램</h2>
    <hr />
    <form>
      <label>이름 <input type="text" /></label>
      <label>전화번호<input type="tel" /></label>
      <label>이메일<input type="email" /></label>
      <button>추가</button>
    </form>
    <h3>저장된 연락처 리스트</h3>
    <table>
      <tbody></tbody>
    </table>
    <hr />
    이메일로 해당 연락처 삭제: <br />
    <form>
      <label>이메일을 입력하세요: <input type="text" /></label>
      <button>삭제</button>
    </form>

    <script>
      (async () => {
        const response = await fetch("http://localhost:8080/contacts");
        // 결과가 배열
        const result = await response.json();
        console.log(result);
        const tbody = document.querySelector("tbody");
        // 배열 반복을 해서 tr만든 다음에 tbody가장 마지막 자식에 추가
        for (let item of result) {
          const template = `<tr data-email="${item.email}">
            <td>${item.name}</td><td>${item.phone}</td><td>${item.email}</td></tr>`;
          tbody.insertAdjacentHTML("afterbegin", template);
        }
      })();

      // 추가폼
      (() => {
        const form = document.forms[0];
        const inputs = form.querySelectorAll("input");
        const name = inputs[0];
        const phone = inputs[1];
        const email = inputs[2];

        const add = form.querySelector("button");

        add.addEventListener("click", async (e) => {
          e.preventDefault();

          if (email.value === "") {
            alert("이메일을 입력해주세요.");
            return;
          }

          if (name.value === "") {
            alert("이름을 입력해주세요.");
            return;
          }

          if (phone.value === "") {
            alert("전화번호를 입력해주세요.");
            return;
          }

          // 서버에 데잍터를 전송
          // fetch(url, options)
          const response = await fetch("http://localhost:8080/contacts", {
            method: "POST", //HTTP Method
            // 보낼 데이터 형식은 json
            headers: {
              "content-type": "application/json",
            },
            body: JSON.stringify({
              email: email.value,
              name: name.value,
              phone: phone.value,
            }),
          });

          console.log(response);
          const result = await response.json();
          console.log(result);

          const tbody = document.querySelector("tbody");
          const tr = document.createElement("tr");

          // 추가할 데이터의 속성 추가
          // 삭제할 때 사용하려고 데이터 속성을 추가함
          // tr.dataset.email = email.value;
          tr.dataset.email = result.data.email;

          tr.innerHTML = `<td>${name.value}</td><td>${phone.value}</td><td>${email.value}</td>`;
          tbody.prepend(tr);
          form.reset();
        });
      })();

      // 삭제폼
      (() => {
        const form = document.forms[1];
        const email = form.querySelector("input");
        const del = form.querySelector("button");

        del.addEventListener("click", (e) => {
          e.preventDefault(); //폼에 제출되는 걸 막는 기능
          const tr = document.querySelector(`tr[data-email="${email.value}"]`);

          if (!tr) {
            alert("해당 이메일의 연락처 없습니다.");
            return;
          }

          tr.remove();

          form.reset();
        });
      })();
    </script>
  </body>
</html>
